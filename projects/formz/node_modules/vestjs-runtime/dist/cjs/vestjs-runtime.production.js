"use strict";var t=require("vest-utils"),e=require("context"),n=require("vest-utils/minifyObject");const r={ASYNC_ISOLATE_DONE:"ASYNC_ISOLATE_DONE",ISOLATE_DONE:"ISOLATE_DONE",ISOLATE_ENTER:"ISOLATE_ENTER",ISOLATE_PENDING:"ISOLATE_PENDING"};var i;"function"==typeof SuppressedError&&SuppressedError,function(t){t.NO_ACTIVE_ISOLATE="Not within an active isolate",t.UNABLE_TO_PICK_NEXT_ISOLATE="Unable to pick next isolate. This is a bug, please report it to the Vest maintainers.",t.ENCOUNTERED_THE_SAME_KEY_TWICE='Encountered the same key "{key}" twice. This may lead to inconsistent or overriding of results.',t.INVALID_ISOLATE_CANNOT_PARSE="Invalid isolate was passed to IsolateSerializer. Cannot proceed."}(i||(i={}));class o{static at(e,n){var r,i;return t.isNullish(e)?null:null!==(i=null===(r=e.children)||void 0===r?void 0:r[n])&&void 0!==i?i:null}static cursor(e){var n,r;return t.isNullish(e)?0:null!==(r=null===(n=e.children)||void 0===n?void 0:n.length)&&void 0!==r?r:0}static canReorder(e){return!t.isNullish(e)&&o.allowsReorder(e.parent)}static allowsReorder(t){return!0===(null==t?void 0:t.allowReorder)}static usesKey(e){return!t.isNullish(e)&&t.isNotNullish(e.key)}static getChildByKey(e,n){var r,i;return t.isNullish(e)?null:null!==(i=null===(r=e.keys)||void 0===r?void 0:r[n])&&void 0!==i?i:null}}class s{static setParent(t,e){return t.parent=e,t}static saveOutput(t,e){return t.output=e,t}static setKey(t,e){return t.key=e,t}static addChild(e,n){var r;t.invariant(e),e.children=null!==(r=e.children)&&void 0!==r?r:[],e.children.push(n),s.setParent(n,e)}static removeChild(t,e){var n,r;t.children=null!==(r=null===(n=t.children)||void 0===n?void 0:n.filter((t=>t!==e)))&&void 0!==r?r:null}static addChildKey(e,n,r){var i;t.invariant(e),e.keys=null!==(i=e.keys)&&void 0!==i?i:{},e.keys[n]=r}static slice(e,n){t.isNullish(e.children)||(e.children.length=n)}static setData(t,e){t.data=e}static abort(e,n){t.isNullish(e.abortController)||e.abortController.abort(n)}}const l=e.createCascade(((e,n)=>{if(n)return null;t.invariant(e.historyRoot);const[r]=e.historyRoot(),i={};return t.assign(i,{historyNode:r,runtimeNode:null,runtimeRoot:null,stateRef:e}),i})),u=l.run,a={Run:u,createRef:function(e,n){return Object.freeze({Bus:t.bus.createBus(),Reconciler:e,appData:t.optionalFunctionValue(n),historyRoot:t.tinyState.createTinyState(null)})},persist:c,reset:function(){const[,,t]=f();t()},useAvailableRoot:function(){const t=v();if(t)return t;const[e]=f();return e},useCurrentCursor:function(){const t=N();return t?o.cursor(t):0},useHistoryRoot:f,useSetHistoryRoot:y,useSetNextIsolateChild:E,useXAppData:function(){return d().stateRef.appData}};function c(t){const e=l.useX();return(...n)=>{var r;const i=null!==(r=l.use())&&void 0!==r?r:e;return l.run(i.stateRef,(()=>t(...n)))}}function d(){return l.useX()}function f(){return d().stateRef.historyRoot()}function h(){return d().historyNode}function p(){const t=N(),e=h();return t?o.at(e,o.cursor(t)):e}function y(t){const[,e]=f();e(t)}function N(){var t;return null!==(t=d().runtimeNode)&&void 0!==t?t:null}function v(){return d().runtimeRoot}function E(e){const n=N();t.invariant(n,i.NO_ACTIVE_ISOLATE),s.addChild(n,e),s.setParent(e,n)}function O(){return d().stateRef.Bus}function _(e,n){const r=O().emit;return t.isNullish(e)||r(e,n),c(r)}var I,T=Object.freeze({__proto__:null,useBus:O,useEmit:_,usePrepareEmitter:function(t){const e=_();return n=>e(t,n)}});!function(t){t.Type="$type",t.Keys="keys",t.Key="key",t.Parent="parent",t.Data="data",t.AllowReorder="allowReorder",t.Status="status",t.AbortController="abortController",t.Children="children"}(I||(I={}));const S=new Set([I.AbortController,I.Parent,I.Keys]);function A(t,e){return(null==t?void 0:t[I.Type])===e}function R(t,e){return A(t,e[I.Type])}var C=Object.freeze({__proto__:null,isIsolateType:A,isSameIsolateIdentity:function(t,e){return Object.is(t,e)||R(t,e)&&t.key===e.key},isSameIsolateType:R});class b{static reconcile(e){const n=function(e,n){var r;if(t.isNullish(n))return function(t){if(o.usesKey(t))return b.handleIsolateNodeWithKey(t,!1);return t}(e);if(!R(e,n))return e;const i=d().stateRef.Reconciler;return null!==(r=i(e,n))&&void 0!==r?r:function(e,n){return t.isNullish(n),e}(e,n)}(e,p());return t.invariant(n,i.UNABLE_TO_PICK_NEXT_ISOLATE),n}static dropNextNodesOnReorder(t,e,n){const r=t(e,n);return r&&function(){const t=N(),e=h();if(!e||!t)return;s.slice(e,o.cursor(t))}(),r}static handleIsolateNodeWithKey(e,n){t.invariant(o.usesKey(e));const r=function(e){if(t.isNullish(e))return null;const n=d().historyNode;return o.getChildByKey(n,e)}(e.key);let l=e;return t.isNullish(r)||t.optionalFunctionValue(n,r)||(l=r),function(e,n){if(!e)return;const r=N();t.invariant(r,i.NO_ACTIVE_ISOLATE),t.isNullish(o.getChildByKey(r,e))?s.addChildKey(r,e,n):t.deferThrow(t.text(i.ENCOUNTERED_THE_SAME_KEY_TWICE,{key:e}))}(e.key,l),l}}class m{static create(e,n,i=void 0,o){const l=N(),a=s.setParent(function(t,e,n=null){const r=null!=e?e:{},{allowReorder:i,status:o}=r,s=function(t,e){var n={};for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(t);i<r.length;i++)e.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(t,r[i])&&(n[r[i]]=t[r[i]])}return n}(r,["allowReorder","status"]);return Object.assign(Object.assign({[I.AllowReorder]:i,[I.AbortController]:new AbortController,[I.Keys]:null,[I.Parent]:null,[I.Type]:t,[I.Data]:s},o&&{[I.Status]:o}),{children:null,key:n,output:null})}(e,i,o),l),c=b.reconcile(a),d=p(),f=Object.is(c,a);l&&E(c);const h=f?function(e,n,i){const o=v(),l=_(),a=u(Object.assign({historyNode:e,runtimeNode:n},!o&&{runtimeRoot:n}),(()=>{l(r.ISOLATE_ENTER,n);const e=i(n);return t.isPromise(e)?(l(r.ISOLATE_PENDING,n),e.then((t=>{m.isIsolate(t)&&s.addChild(n,t),l(r.ISOLATE_DONE,n),l(r.ASYNC_ISOLATE_DONE,n)}))):l(r.ISOLATE_DONE,n),e}));return n.output=a,a}(d,a,n):c.output;return s.saveOutput(c,h),l||y(c),c}static isIsolate(e){return t.isNotNullish(e)&&e[I.Type]}}function k(e,n,r){var i;let o=!1;if(!o){for(const t of null!==(i=e.children)&&void 0!==i?i:[])if(k(t,((t,e)=>{n(t,(()=>{e(),s()}))}),r),o)return;(t.isNullish(r)||t.optionalFunctionValue(r,e))&&n(e,s)}function s(){o=!0}}function L(t,e,n){let r=!1;return k(t,((t,n)=>{e(t)&&(n(),r=!0)}),n),r}function P(t,e){let n=t;do{if(e(n))return n;n=n.parent}while(n);return null}var w=Object.freeze({__proto__:null,closest:P,closestExists:function(t,e){return!!P(t,e)},every:function(t,e,n){let r=!0;return k(t,((t,n)=>{e(t)||(n(),r=!1)}),n),r},find:function(t,e,n){let r=null;return k(t,((t,n)=>{e(t)&&(n(),r=t)}),n),r},findAll:function(t,e,n){const r=[];return k(t,(t=>{e(t)&&r.push(t)}),n),r},findClosest:function(t,e){var n,r;let i=null,o=t;for(;o&&(i=null!==(r=null===(n=o.children)||void 0===n?void 0:n.find(e))&&void 0!==r?r:null,!i);)o=o.parent;return i},has:function(t,e){return L(t,(()=>!0),e)},pluck:function(t,e,n){k(t,(t=>{e(t)&&t.parent&&s.removeChild(t.parent,t)}),n)},reduce:function(t,e,n,r){let i=n;return k(t,((t,n)=>{i=e(i,t,n)}),r),i},some:L,walk:k});class x{static deserialize(e){const r=t.isStringValue(e)?JSON.parse(e):Object.assign({},e),i=n.expandObject(...r);x.validateIsolate(i);const o=[i];for(;o.length;){const t=o.shift();if(!t)continue;const e=t.children;e&&(t.children=e.map((e=>{var n;const r=Object.assign({},e);s.setParent(r,t),o.push(r);const i=r.key;return i&&(t.keys=null!==(n=t.keys)&&void 0!==n?n:{},t.keys[i]=r),r})))}return i}static serialize(e,r){if(t.isNullish(e))return"";const i=n.minifyObject(e,((t,e)=>{if(!S.has(e))return r(t,e)}));return JSON.stringify(i)}static validateIsolate(e){t.invariant(t.hasOwnProperty(e,I.Type),t.text(i.INVALID_ISOLATE_CANNOT_PARSE))}}exports.Bus=T,exports.Isolate=m,exports.IsolateInspector=o,exports.IsolateMutator=s,exports.IsolateSelectors=C,exports.IsolateSerializer=x,exports.Reconciler=b,exports.RuntimeEvents=r,exports.VestRuntime=a,exports.Walker=w;
//# sourceMappingURL=vestjs-runtime.production.js.map
